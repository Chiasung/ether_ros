# Welcome to the EtherROS program tutorial by Mike Karamousadakis

For any questions, send email to: mkaramousadakis @ zoho.eu

For a full documentation, licence and other information, visit the following ReadTheDocs [link](https://ighmaster-userspace-program-in-ros.readthedocs.io/en/latest/).

In the tutorial we assume that an Ubuntu flavor 16.04 is used.

## Installation process

**SUPER SOS :** The following manual will be extremely helpful for understanding the instructions given in this section. You should **definitely** read it before procceding. [Link](http://linuxrealtime.org/index.php/Main_Page).

### 0. Preempt_RT Patch

First step to utilize the repository given, is to install the preempt_rt patch in the kernel. Note that in order to install EtherLab, the kernel should be up to 4.9. A proper guide for the installation procedure can be found in the following [link](https://ubuntuforums.org/showthread.php?t=2273355). After you patch the kernel (say 4.9), you will want to use some other configuration parameters in the build of the kernel. Therefore after step 3 and in the line of *make menuconfig* of the previous link,
you will want to specify some extra configuration parameters, derived from the chapter 3 of the manual mentioned in the beginning, namely:

- CONFIG_PREEMPT_RT_FULL

- CONFIG_CPU_FREQ=n

- CONFIG_CPU_IDLE=n

- CONFIG_NO_HZ_FULL=y

- CONFIG_RCU_NOCB_CPU=y

The author has used only the first configuration parameter and has seen great boost in the performance of the real-time tasks specified. Future work requires more tweaks to be done, derived from the afore mentioned manual.

#### Tip: While you are in the menuconfig, type "/" and you can type to find the place of a configuration parameter. Exit with ESC

### 1. Installation of EtherLab

1. cd into the etherlab-mercurial folder
2. Run *make ethercatMasterInstallWithAutoStart*. Note that root access is needed. If you use another native driver from e1000e, open the Makefile and change the configure option with your driver version. You can find [here](http://www.etherlab.org/en/ethercat/hardware.php) and [here](http://www.etherlab.org/download/ethercat/ethercat-1.5.2.pdf) (Chapter 9), the supported hardware and the options the command *configure* takes, respectively. If your hardware is not supported or if you don't want the native driver support fuzz, then you should change the *configure* command to enable generic driver support (although I think it defaults to that).


### 2. Run the scripts

1. Because we want to have a process in realtime context, we should change it's priority (done in the code -FIFO policy, 80 priority-). Besides that, the interrupt handler which handles the interrupts generated by the network driver, should have higher priority than the process we develop, so that the EtherCAT datagrams are ready to be sent/received before we process them. For that cause I have written a script, as a sample script, to change the priority of the irq process of the network card.This should be used accordingly to change **your** process's priority. You could check if the priority has changed with the *chrt* command. How-to can be found [here](https://www.cyberciti.biz/faq/howto-set-real-time-scheduling-priority-process).

2. Aside from the enhancements proposed by the manual, we should also change the throttling of our network driver to 0. This is done in the script also in the *testbench* directory. It is based on my e1000e driver, so use it as a sample script. Documentation for the insertion of the module of the e1000e network driver can be found [here](https://downloadmirror.intel.com/15817/eng/readme.txt).

3. Run the script for changing the permissions of ether_ros. We set the suid of ether_ros to be root, so that the ether_ros can be launched without *sudo*. This will be useful **after** you *catkin_make* the project.

## Example usage

1. Before running the program, you could restart the ethercat service (the EtherLab Master). To do that, run the following command:

```bash
$ sudo /etc/init.d/ethercat restart
```

The kernel logs can be very useful, because they show what is happening to EtherLab every time, how many packets he has skipped etc. To see the kernel logs, run the command:

```bash
$ tail -f /var/log/kern.log
```

2. After you *catkin_make* the project, in one terminal run:

```bash
$ roslaunch ether_ros ether_ros.launch
```

3. After that, and while the process is running, you run in another terminal:

```bash
$ rosrun ether_ros ethercat_keyboard_controller.py
```

4. Now you can give orders to the EtherCAT Communicator via a custom terminal. Have fun!

- *Tip: You could run a bash script in the custom terminal by running:*

```bash
[ethercat_controller] > !r my_awesome_bash_script.sh
```

Note that your script must be under the *scripts* directory. You could also check some
example scripts there.
